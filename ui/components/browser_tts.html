<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PoseCoachAI TTS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}</style>
</head>
<body>
  <div class="sr-only" id="status" aria-live="polite"></div>
  <script>
    const PAYLOAD = { text:"[[TEXT]]", token:"[[TOKEN]]", rate:[[RATE]], pitch:[[PITCH]], volume:[[VOLUME]], voicePref:"[[VOICE_SUBSTR]]" };
    (function () {
      const synth = window.speechSynthesis;
      if (!synth) { try{localStorage.setItem("posecoach_tts_last_token",PAYLOAD.token)}catch{}; return; }
      const speakIfNew = async () => {
        try{
          const last = localStorage.getItem("posecoach_tts_last_token")||"";
          if(!PAYLOAD.text.trim() || PAYLOAD.token===last) return;
          const getVoices = () => new Promise(r=>{
            const v=synth.getVoices(); if(v&&v.length) return r(v);
            const t=setInterval(()=>{const vs=synth.getVoices(); if(vs&&vs.length){clearInterval(t); r(vs)}},100);
            setTimeout(()=>{clearInterval(t); r(synth.getVoices()||[])},2000);
          });
          const voices = await getVoices();
          let voice=null;
          if(PAYLOAD.voicePref && voices.length){
            const p=PAYLOAD.voicePref.toLowerCase();
            voice=voices.find(v=>(v.name||"").toLowerCase().includes(p)||(v.lang||"").toLowerCase().includes(p))||null;
          }
          if(synth.speaking) synth.cancel();
          const u=new SpeechSynthesisUtterance(PAYLOAD.text);
          if(voice) u.voice=voice;
          u.rate=Math.min(Math.max(PAYLOAD.rate||1.0,0.1),10);
          u.pitch=Math.min(Math.max(PAYLOAD.pitch||1.0,0.0),2);
          u.volume=Math.min(Math.max(PAYLOAD.volume||1.0,0.0),1);
          u.onend=()=>{ try{localStorage.setItem("posecoach_tts_last_token",PAYLOAD.token)}catch{}; const st=document.getElementById("status"); if(st) st.textContent="Spoken"; };
          u.onerror=()=>{ try{localStorage.setItem("posecoach_tts_last_token",PAYLOAD.token)}catch{}; };
          synth.speak(u);
        }catch(e){ try{localStorage.setItem("posecoach_tts_last_token",PAYLOAD.token)}catch{}; }
      };
      speakIfNew();
    })();
  </script>
</body>
</html>
